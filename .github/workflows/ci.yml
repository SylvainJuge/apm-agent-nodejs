name: ci

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '**.asciidoc'
  pull_request:
    paths-ignore:
      - '**.md'
      - '**.asciidoc'

# limit the access of the generated GITHUB_TOKEN
permissions:
  contents: read

jobs:

  filter:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - id: generate
        uses: elastic/apm-pipeline-library/.github/actions/version-framework@test-current
        with:
          versionsFile: .ci/.jenkins_tav_nodejs.yml
          frameworksFile: .ci/.jenkins_tav.yml

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        node:
          - '19'
          - '18'
          - '18.0'
          - '16'
          - '16.0'
          - '14'
          - '14.0'
          - '12'
          - '12.0'
          - '10'
          - '10.0'
          - '8'
          - '8.6'
        contextManager: [ 'patch', '' ]
    steps:
      - uses: actions/checkout@v3
      - run: .ci/scripts/test.sh -b "release" -t "" "${{ matrix.node }}"
        env:
          VERSION: ${{ matrix.node }}
          ELASTIC_APM_CONTEXT_MANAGER: ${{ matrix.contextManager }}

  test-tav:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [filter]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.filter.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v3
      - run: .ci/scripts/test.sh -b "release" -t "${{ matrix.framework }}" "${{ matrix.version }}"
        env:
          VERSION: ${{ matrix.version }}
          ELASTIC_APM_CONTEXT_MANAGER: ''
